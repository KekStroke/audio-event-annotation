# Контекст Проекта: Audio Event Annotation Tool

**Последнее обновление**: 2025-11-10

## 1. Описание Проекта

Веб-приложение для ручной аннотации аудио-событий в больших аудиофайлах (до нескольких ГБ). Инструмент предоставляет интерактивную визуализацию аудио (waveform и спектрограмма), возможность выделения временных участков, прослушивания фрагментов и сохранения результатов разметки.

**Проблема**: 
Исследователям и специалистам по обработке звука необходим эффективный инструмент для ручной разметки больших аудиодатасетов с визуализацией характеристик сигнала и удобным интерфейсом для аннотирования событий.

**Решение**:
Создание легковесного веб-приложения с серверной обработкой аудио и интерактивным фронтендом для визуализации и аннотирования.

## 2. Ключевые Сущности (Entities)

- **AudioFile**:
  - `id`: Integer (Primary Key)
  - `file_path`: String (абсолютный путь к файлу в файловой системе)
  - `filename`: String (имя файла)
  - `duration`: Float (длительность в секундах)
  - `sample_rate`: Integer (частота дискретизации)
  - `channels`: Integer (количество каналов)
  - `file_size`: Integer (размер в байтах)
  - `created_at`: Datetime
  - `last_accessed`: Datetime

- **Annotation**:
  - `id`: Integer (Primary Key)
  - `audio_file_id`: Integer (Foreign Key -> AudioFile)
  - `start_time`: Float (начало фрагмента в секундах)
  - `end_time`: Float (конец фрагмента в секундах)
  - `event_type_id`: Integer (Foreign Key -> EventType, nullable)
  - `label`: String (текстовая метка события)
  - `confidence`: Integer (уверенность разметчика: 1-5, nullable)
  - `notes`: Text (дополнительные заметки)
  - `created_at`: Datetime
  - `updated_at`: Datetime

- **EventType**:
  - `id`: Integer (Primary Key)
  - `name`: String (название типа события, уникальное)
  - `description`: Text (описание типа события)
  - `color`: String (hex-цвет для визуализации)
  - `created_at`: Datetime

- **Project**:
  - `id`: Integer (Primary Key)
  - `name`: String (название проекта/датасета)
  - `description`: Text
  - `root_directory`: String (корневая директория аудиофайлов)
  - `created_at`: Datetime
  - `updated_at`: Datetime

## 3. Технологический Стек

- **Backend**: Python 3.10+, Flask (монолитная архитектура для MVP)
- **Audio Processing**: librosa, soundfile, numpy, scipy
- **Database**: SQLite (для хранения метаданных и аннотаций)
- **ORM**: SQLAlchemy
- **Frontend**: Vanilla JavaScript + HTML5 Canvas (минимизация NPM-зависимостей)
- **Audio Visualization**: WaveSurfer.js (CDN) или собственная реализация на Canvas
- **Testing**: pytest (unit), behave (BDD)
- **API**: RESTful JSON API

## 4. Архитектурные Решения (Decision Log)

- **2025-11-10**: Принято решение использовать монолитную архитектуру Flask для MVP, чтобы упростить разработку и развертывание.

- **2025-11-10**: Аудиофайлы НЕ загружаются на сервер, а читаются напрямую из файловой системы пользователя. Сервер предоставляет API для потоковой передачи фрагментов аудио.

- **2025-11-10**: Для обработки больших файлов (несколько ГБ) используется чанкинг: сервер генерирует waveform и спектрограммы по запросу для видимого временного окна, а не для всего файла сразу.

- **2025-11-10**: Визуализация выполняется на клиенте с использованием Canvas API для снижения нагрузки на сервер.

- **2025-11-10**: Экспорт аннотаций в стандартные форматы (JSON, CSV, Audacity labels) для совместимости с другими инструментами.

- **2025-11-10**: Разработка ведется по BDD-методологии. Тесты пишутся до кода.

- **2025-11-10**: Максимальный размер файла кодовой базы — 400 строк. При превышении необходим рефакторинг.

## 5. Функциональные Требования MVP

### 5.1 Управление Проектами
- Создание проекта с указанием корневой директории
- Просмотр списка проектов
- Выбор проекта для работы

### 5.2 Работа с Аудиофайлами
- Сканирование директории и индексация аудиофайлов
- Отображение списка файлов с метаданными
- Выбор файла для аннотирования

### 5.3 Визуализация
- Отображение waveform для всего файла (overview)
- Детальная waveform для выбранного временного окна
- Спектрограмма для выбранного временного окна
- Навигация по временной шкале (zoom, pan)

### 5.4 Аннотирование
- Выделение временного участка мышью
- Прослушивание выделенного фрагмента
- Добавление метки с типом события
- Редактирование существующих аннотаций
- Удаление аннотаций
- Отображение всех аннотаций на временной шкале

### 5.5 Управление Типами Событий
- Создание пользовательских типов событий
- Редактирование и удаление типов
- Назначение цветов для визуального различия

### 5.6 Экспорт Данных
- Экспорт аннотаций в JSON
- Экспорт в CSV
- Экспорт в формат Audacity labels

## 6. Технические Ограничения

- Поддержка форматов: WAV, MP3, FLAC, OGG
- Максимальная длительность файла: без ограничений (потоковая обработка)
- Поддержка моно и стерео аудио
- Клиент работает в современных браузерах (Chrome, Firefox, Edge)

## 7. Структура Проекта

```
audio_event_annotations/
├── app/
│   ├── __init__.py
│   ├── models.py          # SQLAlchemy модели
│   ├── routes/
│   │   ├── __init__.py
│   │   ├── projects.py    # Эндпоинты для проектов
│   │   ├── audio.py       # Эндпоинты для аудио
│   │   └── annotations.py # Эндпоинты для аннотаций
│   ├── services/
│   │   ├── __init__.py
│   │   ├── audio_processor.py  # Обработка аудио
│   │   └── file_scanner.py     # Сканирование файлов
│   └── utils/
│       └── validators.py
├── static/
│   ├── js/
│   │   ├── app.js
│   │   ├── audio_player.js
│   │   └── visualizer.js
│   ├── css/
│   │   └── styles.css
│   └── index.html
├── tests/
│   ├── unit/
│   └── features/          # BDD тесты
├── docs/
│   └── PROJECT_CONTEXT.md
├── migrations/            # Alembic миграции
├── requirements.txt
├── config.py
└── run.py
```

