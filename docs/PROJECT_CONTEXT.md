# Контекст Проекта: Audio Event Annotations

**Последнее обновление**: 2025-11-10

## 1. Описание Проекта

Веб-приложение для ручной разметки аудио-датасетов. Позволяет загружать большие аудиофайлы (несколько гигабайт) из файловой системы, визуализировать их (waveform и спектрограмма), воспроизводить аудио, выделять участки для детального анализа и размечать события (events) с последующим сохранением аннотаций.

### Проблема
Исследователям и специалистам по машинному обучению необходим удобный инструмент для ручной разметки событий в больших аудиофайлах. Существующие решения либо не поддерживают работу с очень большими файлами, либо не предоставляют достаточно гибкие средства визуализации и анализа.

### Решение
Создать специализированное веб-приложение с оптимизированной загрузкой аудио по частям (streaming), интерактивной визуализацией и удобным интерфейсом для выделения и аннотирования аудио-событий.

## 2. Ключевые Сущности (Entities)

- **AudioFile**:
  - `id`: UUID
  - `file_path`: String (путь к файлу в файловой системе)
  - `filename`: String
  - `duration`: Float (длительность в секундах)
  - `sample_rate`: Integer
  - `channels`: Integer
  - `file_size`: Integer (в байтах)
  - `created_at`: Timestamp
  - `updated_at`: Timestamp

- **AudioSegment**:
  - `id`: UUID
  - `audio_file_id`: UUID (FK)
  - `start_time`: Float (в секундах)
  - `end_time`: Float (в секундах)
  - `created_at`: Timestamp

- **Event**:
  - `id`: UUID
  - `name`: String (название типа события)
  - `description`: String (опциональное описание)
  - `color`: String (hex код для визуализации)
  - `created_at`: Timestamp

- **Annotation**:
  - `id`: UUID
  - `audio_file_id`: UUID (FK)
  - `event_id`: UUID (FK)
  - `start_time`: Float (в секундах)
  - `end_time`: Float (в секундах)
  - `confidence`: Float (уверенность разметчика, 0-1)
  - `notes`: Text (дополнительные заметки)
  - `created_at`: Timestamp
  - `updated_at`: Timestamp

- **Project**:
  - `id`: UUID
  - `name`: String
  - `description`: Text
  - `created_at`: Timestamp
  - `updated_at`: Timestamp

## 3. Технологический Стек

- **Backend**: Python + Flask (легковесный фреймворк для MVP)
- **Audio Processing**: 
  - librosa (анализ аудио, спектрограммы)
  - soundfile (чтение аудиофайлов)
  - pydub (манипуляции с аудио)
- **Database**: SQLite (для MVP, легко мигрировать на PostgreSQL позже)
- **Frontend**: 
  - HTML5 + Vanilla JavaScript (без NPM-зависимостей)
  - Wavesurfer.js (via CDN) для визуализации waveform
  - Canvas API для спектрограмм
- **Testing**: pytest + pytest-bdd (BDD-подход)
- **ORM**: SQLAlchemy (для работы с БД)

## 4. Архитектурные Решения (Decision Log)

- **2025-11-10**: Принято решение использовать монолитную архитектуру (Flask) для MVP, чтобы ускорить разработку и упростить развертывание.

- **2025-11-10**: Для работы с большими аудиофайлами будет реализован streaming подход: аудио загружается и обрабатывается по частям (chunks), а не целиком в память.

- **2025-11-10**: Отказ от NPM-зависимостей на фронтенде. Все библиотеки подключаются через CDN для минимизации рисков безопасности и упрощения сборки.

- **2025-11-10**: Разработка ведется по BDD-методологии. Тесты пишутся до кода. Каждая фича должна начинаться с .feature файла.

- **2025-11-10**: Аудиофайлы остаются в файловой системе пользователя. В БД хранятся только метаданные и пути к файлам. Это решает проблему хранения больших объемов данных.

- **2025-11-10**: API возвращает предварительно рассчитанные waveform данные (downsampled) для быстрой отрисовки. Спектрограммы генерируются по запросу для выделенных участков.

- **2025-11-10**: Максимальный размер файла ограничен 500 строками. При превышении требуется рефакторинг на более мелкие модули.

## 5. Ключевые Функциональные Требования (MVP)

1. **Загрузка аудиофайлов**: Выбор файла из файловой системы, сканирование метаданных
2. **Визуализация**: Отображение waveform и спектрограммы
3. **Воспроизведение**: Проигрывание аудио с возможностью паузы и перемотки
4. **Выделение участков**: Интерактивное выделение временных интервалов
5. **Аннотирование**: Создание, редактирование и удаление аннотаций событий
6. **Управление событиями**: CRUD операции для типов событий
7. **Экспорт**: Сохранение аннотаций в JSON/CSV формате

## 6. Структура Проекта

```
audio_event_annotations/
├── app/
│   ├── __init__.py
│   ├── models/              # SQLAlchemy модели
│   ├── routes/              # Flask blueprints
│   ├── services/            # Бизнес-логика
│   └── utils/               # Вспомогательные функции
├── static/
│   ├── css/
│   ├── js/
│   └── lib/                 # CDN fallbacks
├── templates/               # Jinja2 шаблоны
├── tests/
│   ├── features/            # BDD .feature файлы
│   └── step_defs/           # Step definitions
├── docs/
│   └── PROJECT_CONTEXT.md
├── config.py
├── requirements.txt
└── run.py
```

