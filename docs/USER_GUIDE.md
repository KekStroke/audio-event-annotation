# Руководство пользователя Audio Event Annotation Tool

## Оглавление

1. [Введение](#введение)
2. [Установка и запуск](#установка-и-запуск)
3. [Основные функции](#основные-функции)
4. [Работа с интерфейсом](#работа-с-интерфейсом)
5. [Примеры использования](#примеры-использования)
6. [Часто задаваемые вопросы](#часто-задаваемые-вопросы)

## Введение

Audio Event Annotation Tool - это веб-приложение для ручной аннотации больших аудио-файлов. Инструмент позволяет:

- Визуализировать аудио через waveform и спектрограмму
- Выделять временные интервалы
- Прослушивать фрагменты
- Размечать наличие интересующих событий для создания датасетов
- Экспортировать аннотации в JSON формате

## Установка и запуск

### Требования

- Python 3.11 или выше
- pip (менеджер пакетов Python)

### Установка

1. **Клонируйте репозиторий:**
```bash
git clone https://github.com/KekStroke/audio-event-annotation.git
cd audio-event-annotation
```

2. **Создайте виртуальное окружение:**
```bash
python -m venv venv
```

3. **Активируйте виртуальное окружение:**
   - Windows:
   ```bash
   venv\Scripts\activate
   ```
   - Linux/macOS:
   ```bash
   source venv/bin/activate
   ```

4. **Установите зависимости:**
```bash
pip install -r requirements.txt
```

### Запуск приложения

1. Убедитесь, что виртуальное окружение активировано

2. Запустите Flask приложение:
```bash
python app.py
```

3. Откройте браузер и перейдите по адресу:
```
http://localhost:5000
```

## Основные функции

### 1. Загрузка аудио файла

Приложение работает с аудио-файлами из локальной файловой системы. Для загрузки файла используйте API:

```bash
curl -X POST http://localhost:5000/api/audio/add \
  -H "Content-Type: application/json" \
  -d '{"file_path": "/path/to/your/audio.wav"}'
```

**Поддерживаемые форматы:**
- WAV
- MP3
- FLAC
- OGG
- И другие форматы, поддерживаемые librosa и soundfile

**Ограничения:**
- Максимальный размер файла: 16GB
- Файл должен существовать в файловой системе

### 2. Визуализация аудио

После загрузки файла доступны два типа визуализации:

#### Waveform (Волновая форма)
- Отображает амплитуду сигнала во времени
- Автоматически генерируется при загрузке файла
- Кэшируется на диске для быстрого доступа
- Поддерживает масштабирование (Zoom In/Out)

#### Spectrogram (Спектрограмма)
- Отображает частотный спектр сигнала во времени
- Генерируется по запросу для выбранного временного интервала
- Настраиваемые параметры (временной интервал, размер, цветовая карта)

### 3. Создание аннотаций

Аннотации позволяют размечать интересующие события в аудио:

1. **Выделение региона:**
   - Нажмите и удерживайте левую кнопку мыши на waveform
   - Перетащите для выделения временного интервала
   - Время региона отображается под waveform

2. **Создание аннотации:**
   - Выделите регион на waveform
   - Нажмите кнопку "Create Annotation"
   - Заполните форму:
     - **Event Label** (обязательно): Название события
     - **Confidence** (опционально): Уровень уверенности (0.0 - 1.0)
     - **Notes** (опционально): Дополнительные заметки
   - Нажмите "Save"

3. **Редактирование аннотации:**
   - Нажмите на аннотацию в списке справа
   - Нажмите кнопку "Edit"
   - Измените данные
   - Нажмите "Save"

4. **Удаление аннотации:**
   - Нажмите на аннотацию в списке справа
   - Нажмите кнопку "Delete"
   - Подтвердите удаление

### 4. Экспорт аннотаций

Все аннотации можно экспортировать в JSON формате:

1. **Через UI:**
   - Нажмите кнопку "Export" в workspace
   - JSON файл автоматически скачается

2. **Через API:**
```bash
curl http://localhost:5000/api/audio/{id}/export?format=json \
  -o annotations.json
```

**Формат экспорта:**
```json
{
  "audio_file": {
    "id": "uuid",
    "filename": "audio.wav",
    "duration": 10.5,
    ...
  },
  "annotations": [
    {
      "id": "uuid",
      "start_time": 1.0,
      "end_time": 2.5,
      "event_label": "Speaker 1",
      ...
    }
  ],
  "export_date": "ISO8601",
  "version": "1.0"
}
```

## Работа с интерфейсом

### Структура интерфейса

Приложение имеет следующий интерфейс:

1. **Toolbar** - Панель инструментов вверху
2. **Sidebar** - Боковая панель с аннотациями
3. **Workspace** - Рабочая область с waveform
4. **Control Panel** - Панель управления внизу

### Элементы управления

#### Waveform
- **Клик по waveform**: Перемотка к выбранному времени
- **Перетаскивание**: Выделение временного интервала
- **Zoom In/Out**: Масштабирование waveform

#### Кнопки управления
- **Play/Pause**: Воспроизведение/пауза аудио
- **Play Selection**: Воспроизведение выделенного региона
- **Create Annotation**: Создание аннотации для выделенного региона
- **Clear Selection**: Очистка выделения
- **Zoom to Region**: Масштабирование к выделенному региону
- **Export**: Экспорт всех аннотаций в JSON

#### Горячие клавиши
- **Space**: Воспроизведение/пауза аудио
- **← →**: Перемотка (планируется)

### Работа с регионами

1. **Выделение региона:**
   - Нажмите и удерживайте левую кнопку мыши на waveform
   - Перетащите для выделения интервала
   - Время региона отображается в формате MM:SS

2. **Изменить размер региона:**
   - Наведите курсор на границу региона
   - Перетащите для изменения размера

3. **Переместить регион:**
   - Наведите курсор на центр региона
   - Перетащите для перемещения

4. **Удалить регион:**
   - Нажмите на регион
   - Нажмите кнопку "Clear Selection"

### Работа с аннотациями

#### Список аннотаций
- Отображается в боковой панели справа
- Показывает все аннотации для текущего файла
- Каждая аннотация отображает:
  - Временной интервал (MM:SS - MM:SS)
  - Event Label
  - Confidence (если указан)
  - Кнопки Edit и Delete

#### Цветовое кодирование
- Каждая аннотация имеет свой цвет на waveform
- Цвета автоматически назначаются для визуального различия

#### Синхронизация
- Клик по аннотации в списке выделяет соответствующий регион на waveform
- Регионы на waveform синхронизированы со списком аннотаций

## Примеры использования

### Пример 1: Базовое использование

1. Загрузите аудио файл через API
2. Откройте файл в UI
3. Выделите регион на waveform
4. Создайте аннотацию
5. Экспортируйте все аннотации

### Пример 2: Массовое создание аннотаций

```python
import requests

base_url = "http://localhost:5000"
audio_file_id = "your-audio-file-id"

annotations = [
    {"start_time": 1.0, "end_time": 2.5, "event_label": "Speaker 1"},
    {"start_time": 3.0, "end_time": 4.5, "event_label": "Speaker 2"},
    {"start_time": 5.0, "end_time": 6.5, "event_label": "Noise"},
]

for ann in annotations:
    ann["audio_file_id"] = audio_file_id
    response = requests.post(f"{base_url}/api/annotations", json=ann)
    print(f"Created: {response.json()}")
```

### Пример 3: Работа с большими файлами

Приложение оптимизировано для работы с большими файлами:

- Waveform и спектрограммы кэшируются на диске
- Аудио файлы загружаются по частям (HTTP Range requests)
- Используется downsampling для waveform визуализации

## Часто задаваемые вопросы

### Q: Какой формат аудио файлов поддерживается?

A: Приложение поддерживает все форматы, которые поддерживает `librosa` и `soundfile`:
- WAV
- MP3
- FLAC
- OGG
- И другие

### Q: Какой максимальный размер файла?

A: Максимальный размер файла - 16GB (настраивается в `app.py`).

### Q: Где хранятся кэшированные waveform и спектрограммы?

A: По умолчанию в директории `cache/` в корне проекта. Можно настроить через переменные окружения:
- `WAVEFORM_CACHE_DIR` - для waveform
- `SPECTROGRAM_CACHE_DIR` - для спектрограмм

### Q: Как удалить все аннотации для файла?

A: Используйте API для удаления каждой аннотации или удалите файл из БД (все аннотации удалятся автоматически из-за cascade delete).

### Q: Можно ли импортировать аннотации из JSON?

A: Импорт аннотаций будет добавлен в будущих версиях. Сейчас можно использовать API для создания аннотаций из JSON.

### Q: Как работает кэширование?

A: Waveform и спектрограммы кэшируются на диске по ключу, основанному на параметрах файла и запроса. При повторном запросе с теми же параметрами используется кэшированная версия.

### Q: Как изменить порт приложения?

A: Измените порт в `app.py`:
```python
app.run(host="127.0.0.1", port=5000, debug=True)
```

### Q: Поддерживается ли работа с несколькими файлами одновременно?

A: Да, можно загрузить несколько файлов и работать с ними по очереди. Каждый файл имеет свой список аннотаций.

### Q: Как сохранить аннотации?

A: Аннотации автоматически сохраняются в базе данных SQLite. Для экспорта используйте функцию "Export" или API endpoint `/api/audio/{id}/export?format=json`.

### Q: Можно ли работать без интернета?

A: Да, приложение работает полностью локально. Все данные хранятся в локальной базе данных SQLite.

## Поддержка

Если у вас возникли проблемы или вопросы:

1. Проверьте документацию в `README.md`
2. Проверьте руководство по использованию в `docs/USAGE.md`
3. Проверьте документацию API в `docs/API.md`
4. Запустите тесты: `pytest -v`
5. Создайте issue в GitHub репозитории

## Лицензия

MIT

## Автор

KekStroke

