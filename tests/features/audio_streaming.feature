Feature: Потоковая загрузка больших аудио-файлов
  Как пользователь API
  Я хочу получать аудио-файлы чанками
  Чтобы работать с большими файлами без загрузки всего файла в память

  Background:
    Given Flask приложение запущено
    And база данных инициализирована

  Scenario: Потоковая загрузка аудио-файла
    Given в БД существует AudioFile с id
    And файл существует по пути из AudioFile
    When я отправляю GET запрос на "/api/audio/{id}/stream"
    Then ответ должен иметь статус 200
    And ответ должен иметь заголовок "Content-Type" содержащий "audio"
    And ответ должен иметь заголовок "Accept-Ranges" равный "bytes"
    And ответ должен содержать аудио данные

  Scenario: Потоковая загрузка с Range запросом - начало файла
    Given в БД существует AudioFile с id
    And файл существует по пути из AudioFile
    When я отправляю GET запрос на "/api/audio/{id}/stream" с заголовком "Range: bytes=0-1048575"
    Then ответ должен иметь статус 206
    And ответ должен иметь заголовок "Content-Range"
    And заголовок "Content-Range" должен начинаться с "bytes 0-1048575"
    And ответ должен содержать ровно 1048576 байт данных

  Scenario: Потоковая загрузка с Range запросом - середина файла
    Given в БД существует AudioFile с id
    And файл существует по пути из AudioFile
    When я отправляю GET запрос на "/api/audio/{id}/stream" с заголовком "Range: bytes=1048576-2097151"
    Then ответ должен иметь статус 206
    And ответ должен иметь заголовок "Content-Range"
    And ответ должен содержать ровно 1048576 байт данных

  Scenario: Потоковая загрузка с Range запросом - конец файла
    Given в БД существует AudioFile с id
    And файл существует по пути из AudioFile
    And размер файла больше 2MB
    When я отправляю GET запрос на "/api/audio/{id}/stream" с заголовком "Range: bytes=-1048576"
    Then ответ должен иметь статус 206
    And ответ должен иметь заголовок "Content-Range"
    And ответ должен содержать данные

  Scenario: Ошибка при потоковой загрузке несуществующего файла
    Given в БД существует AudioFile с id
    And файл НЕ существует по пути из AudioFile
    When я отправляю GET запрос на "/api/audio/{id}/stream"
    Then ответ должен иметь статус 404
    And ответ должен содержать JSON с полем "error"

  Scenario: Ошибка при потоковой загрузке несуществующего AudioFile
    Given в БД не существует AudioFile с id "00000000-0000-0000-0000-000000000000"
    When я отправляю GET запрос на "/api/audio/00000000-0000-0000-0000-000000000000/stream"
    Then ответ должен иметь статус 404
    And ответ должен содержать JSON с полем "error"

  Scenario: Потоковая загрузка использует чанки размером 1MB
    Given в БД существует AudioFile с id
    And файл существует по пути из AudioFile
    And размер файла больше 2MB
    When я отправляю GET запрос на "/api/audio/{id}/stream"
    Then ответ должен загружаться чанками
    And каждый чанк должен быть не больше 1048576 байт

